version: "3.8"

services:
  # --- SEGURIDAD (IDS/NSM) ---
  suricata:
    build: ./suricata
    container_name: soc-suricata
    restart: always
    cap_add:
      - NET_ADMIN
      - SYS_NICE
      - NET_RAW
    networks:
      - soc-net
    volumes:
      - ./suricata/suricata.yaml:/etc/suricata/suricata.yaml
      - ./suricata/rules:/var/lib/suricata/rules
      - suricata-logs:/var/log/suricata

  zeek:
    image: zeek/zeek:latest
    container_name: soc-zeek
    restart: always
    cap_add:
      - NET_ADMIN
      - NET_RAW
    networks:
      - soc-net
    volumes:
      - ./zeek/local.zeek:/usr/local/zeek/share/zeek/site/local.zeek
      - zeek-logs:/usr/local/zeek/logs
    command: zeek -C -i eth0 local

  # --- ATACANTE (GENERADOR DE TRÁFICO) ---
  attacker:
    build: ./traffic-generator
    container_name: soc-attacker
    restart: unless-stopped
    networks:
      - soc-net
    depends_on:
      - suricata
      - grafana

  # --- LOGGING & VISUALIZACIÓN ---
  promtail:
    image: grafana/promtail:2.9.2
    container_name: soc-promtail
    restart: always
    networks:
      - soc-net
    volumes:
      - ./promtail/promtail-config.yml:/etc/promtail/config.yml
      - suricata-logs:/var/log/suricata
      - zeek-logs:/var/log/zeek
    command: -config.file=/etc/promtail/config.yml

  loki:
    image: grafana/loki:2.9.2
    container_name: soc-loki
    restart: always
    networks:
      - soc-net
    expose:
      - "3100"
    command: -config.file=/etc/loki/local-config.yaml

  grafana:
    image: grafana/grafana:10.2.2
    container_name: soc-grafana
    restart: always
    networks:
      - soc-net
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
    depends_on:
      - loki
      - prometheus
    volumes:
      - grafana-data:/var/lib/grafana
      # Si tienes provisionamiento automático:
      - ./grafana/provisioning:/etc/grafana/provisioning

  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: soc-prometheus
    restart: always
    networks:
      - soc-net
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    command: --config.file=/etc/prometheus/prometheus.yml

  node-exporter:
    image: prom/node-exporter:latest
    container_name: soc-node-exporter
    restart: always
    networks:
      - soc-net

networks:
  soc-net:
    driver: bridge

volumes:
  suricata-logs:
  zeek-logs:
  grafana-data:
